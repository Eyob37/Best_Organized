<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Multiplayer Ludo</title>
    <style>
        body {
            display: flex;
            height: 100vh;
            align-items: center;
            justify-content: center;
            background: #f3f3f3;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .status {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            border: 2px solid #e9ecef;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .player-tag {
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        }

        .red-tag { background: #e74c3c; }
        .green-tag { background: #2ecc71; }
        .blue-tag { background: #3498db; }
        .yellow-tag { background: #f1c40f; }

        .main-container {
            background: white;
            width: 100%;
            height: 400px;
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
            margin: auto;
            border: 3px solid #333;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        /* Four home squares */
        .red {         
            grid-row: 1 / 7;
            grid-column: 1 / 7;
            border: 15px solid #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px 0 0 0;
        }
        .green {         
            grid-row: 1 / 7;
            grid-column: 10 / 16;
            border: 15px solid #2ecc71;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 0 10px 0 0;
        }
        .blue {         
            grid-row: 10 / 16;
            grid-column: 1 / 7;
            border: 15px solid #3498db;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 0 0 0 10px;
        }
        .yellow {         
            grid-row: 10 / 16;
            grid-column: 10 / 16;
            border: 15px solid #f1c40f;
            background: rgba(241, 196, 15, 0.1);
            border-radius: 0 0 10px 0;
        }

        /* Pathways between colors */
        .btRedGreen {
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            grid-template-columns: repeat(3, 1fr);         
            grid-row: 1 / 7;
            grid-column: 7 / 10;
        }      
        .btGreenYellow {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            grid-template-columns: repeat(6, 1fr);
            grid-row: 7 / 10;
            grid-column: 10 / 16;
        }
        .btBlueYellow {   
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            grid-template-columns: repeat(3, 1fr);         
            grid-row: 10 / 16;
            grid-column: 7 / 10;
        }
        .btBlueRed {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            grid-template-columns: repeat(6, 1fr);
            grid-row: 7 / 10;
            grid-column: 1 / 7;
        }

        /* center 3x3 cell */
        .center {
            grid-row: 7 / 10;
            grid-column: 7 / 10;
            position: relative;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-rows: 1fr 1fr;
            grid-template-columns: 1fr 1fr;
            box-sizing: border-box;
            overflow: hidden;
            background: #f8f9fa;
            border-radius: 50%;
            border: 3px solid #333;
        }

        /* Each triangle fills its quadrant */
        .center .tri {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* Top-left triangle (red) */
        .center .red {
            background: #e74c3c;
            clip-path: polygon(0 0, 0 70%, 40% 35%);
        }

        /* Top-right triangle (green) */
        .center .green {
            background: #2ecc71;
            clip-path: polygon(100% 0, 70% 0, 35% 40%);
        }

        /* Bottom-right triangle (yellow) */
        .center .yellow {
            background: #f1c40f;
            clip-path: polygon(100% 100%, 39% 35%, 100% 30%);  
        }

        /* Bottom-left triangle (blue) */
        .center .blue {
            background: #3498db;
            clip-path: polygon(0 100%, 40% 35%, 30% 100%);
        }

        .sub-container {
            position: relative;
        }
        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Border for each cell */
        .btwn div {
            border: 1px solid #bbb;
            box-sizing: border-box;
            font-size: 12px;
        }

        /* Beautiful Roller Styles */
        .roller {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #f0f0f0, #c9c9c9);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.8),
                inset 0 -1px 0 rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: none;
        }

        .roller:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 12px rgba(0,0,0,0.25),
                inset 0 1px 0 rgba(255,255,255,0.8),
                inset 0 -1px 0 rgba(0,0,0,0.1);
        }

        .roller:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.8),
                inset 0 -1px 0 rgba(0,0,0,0.1);
        }

        .roller:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .roller::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
            border-radius: 10px 10px 0 0;
        }

        .dice {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            position: relative;
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .dice::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 50%);
        }

        .dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #333;
            border-radius: 50%;
        }

        /* Dice face patterns */
        .dice[data-value="1"] .dot:nth-child(1) {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .dice[data-value="2"] .dot {
            display: none;
        }
        .dice[data-value="2"] .dot:nth-child(1) {
            display: block;
            top: 25%;
            left: 25%;
        }
        .dice[data-value="2"] .dot:nth-child(2) {
            display: block;
            bottom: 25%;
            right: 25%;
        }

        .dice[data-value="3"] .dot:nth-child(1) {
            top: 25%;
            left: 25%;
        }
        .dice[data-value="3"] .dot:nth-child(2) {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .dice[data-value="3"] .dot:nth-child(3) {
            bottom: 25%;
            right: 25%;
        }

        .dice[data-value="4"] .dot {
            display: none;
        }
        .dice[data-value="4"] .dot:nth-child(1) {
            display: block;
            top: 25%;
            left: 25%;
        }
        .dice[data-value="4"] .dot:nth-child(2) {
            display: block;
            top: 25%;
            right: 25%;
        }
        .dice[data-value="4"] .dot:nth-child(3) {
            display: block;
            bottom: 25%;
            left: 25%;
        }
        .dice[data-value="4"] .dot:nth-child(4) {
            display: block;
            bottom: 25%;
            right: 25%;
        }

        .dice[data-value="5"] .dot:nth-child(1) {
            top: 25%;
            left: 25%;
        }
        .dice[data-value="5"] .dot:nth-child(2) {
            top: 25%;
            right: 25%;
        }
        .dice[data-value="5"] .dot:nth-child(3) {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .dice[data-value="5"] .dot:nth-child(4) {
            bottom: 25%;
            left: 25%;
        }
        .dice[data-value="5"] .dot:nth-child(5) {
            bottom: 25%;
            right: 25%;
        }

        .dice[data-value="6"] .dot:nth-child(1) {
            top: 25%;
            left: 25%;
        }
        .dice[data-value="6"] .dot:nth-child(2) {
            top: 25%;
            right: 25%;
        }
        .dice[data-value="6"] .dot:nth-child(3) {
            top: 50%;
            left: 25%;
            transform: translateY(-50%);
        }
        .dice[data-value="6"] .dot:nth-child(4) {
            top: 50%;
            right: 25%;
            transform: translateY(-50%);
        }
        .dice[data-value="6"] .dot:nth-child(5) {
            bottom: 25%;
            left: 25%;
        }
        .dice[data-value="6"] .dot:nth-child(6) {
            bottom: 25%;
            right: 25%;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .DivLeft, .DivRight {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .player-label {
            margin-top: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        .initial-point {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .player {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 3px solid #7b4c2c;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player.selectable {
            transform: scale(1.2);
            box-shadow: 0 0 10px gold;
        }

        .red-player { background: #e74c3c; }
        .green-player { background: #2ecc71; }
        .blue-player { background: #3498db; }
        .yellow-player { background: #f1c40f; }

        .setup-screen {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .setup-screen h2 {
            margin-top: 0;
            color: #333;
        }

        .btn {
            background: #4a6ee0;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            font-weight: bold;
        }

        .btn:hover {
            background: #3a5ec0;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin: 15px 0;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .color-options {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
        }

        .room-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            word-break: break-all;
        }

        .hidden {
            display: none;
        }

        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .online {
            background: #2ecc71;
        }

        .offline {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div id="setupScreen" class="setup-screen">
        <h2>Online Ludo Game</h2>
        <div class="input-group">
            <label for="playerName">Your Name</label>
            <input type="text" id="playerName" placeholder="Enter your name" value="Player">
        </div>
        
        <div class="input-group">
            <label>Choose Your Color</label>
            <div class="color-options">
                <div class="color-option selected" style="background: #e74c3c;" data-color="red"></div>
                <div class="color-option" style="background: #2ecc71;" data-color="green"></div>
                <div class="color-option" style="background: #3498db;" data-color="blue"></div>
                <div class="color-option" style="background: #f1c40f;" data-color="yellow"></div>
            </div>
        </div>
        
        <div class="input-group">
            <label for="roomAction">Game Action</label>
            <select id="roomAction">
                <option value="create">Create New Room</option>
                <option value="join">Join Existing Room</option>
            </select>
        </div>
        
        <div class="input-group" id="roomIdGroup">
            <label for="roomId">Room ID</label>
            <input type="text" id="roomId" placeholder="Enter room ID">
        </div>
        
        <button id="startGame" class="btn">Start Game</button>
        
        <div id="roomInfo" class="room-info hidden">
            <p>Share this Room ID with other players:</p>
            <p id="shareRoomId"></p>
            <p>Waiting for players to join...</p>
        </div>
    </div>

    <div id="gameScreen" class="game-container hidden">
        <div class="header">
            <h1>Online Ludo</h1>
            <div class="status" id="gameStatus">Setting up game...</div>
        </div>
        
        <div class="player-info">
            <div class="player-tag red-tag">Red</div>
            <div class="player-tag green-tag">Green</div>
            <div class="player-tag blue-tag">Blue</div>
            <div class="player-tag yellow-tag">Yellow</div>
        </div>
        
        <div class="main-container">
            <div class="sub-container red"></div>
            <div class="btRedGreen btwn"></div>
            <div class="sub-container green"></div>
            <div class="btGreenYellow btwn"></div>
            <div class="sub-container blue"></div>      
            <div class="btBlueYellow btwn"></div>  
            <div class="sub-container yellow"> </div>        
            <div class="btBlueRed btwn"></div>  
           <div class="center">          
              <div class="tri green" data-gridno="6" data-idno="6271"></div>
              <div class="tri yellow" data-ylidno="6" data-idno="6272"></div>
              <div class="tri blue" data-blidno="6" data-idno="6273"></div>
              <div class="tri red" data-rdidno="6" data-idno="6274"></div>
            </div>
        </div>
        
        <div class="controls">
            <div class="DivLeft">
                <button class="roller" style="background: #e74c3c;" data-color="red">
                    <div class="dice" data-value="1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </button>
                <div class="player-label">Red</div>
            </div>
            
            <div class="DivRight">
                <button class="roller" style="background: #2ecc71;" data-color="green">
                    <div class="dice" data-value="1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </button>
                <div class="player-label">Green</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="DivLeft">
                <button class="roller" style="background: #3498db;" data-color="blue">
                    <div class="dice" data-value="1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </button>
                <div class="player-label">Blue</div>
            </div>
            
            <div class="DivRight">
                <button class="roller" style="background: #f1c40f;" data-color="yellow">
                    <div class="dice" data-value="1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </button>
                <div class="player-label">Yellow</div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            onValue,
            update,
            push,
            child
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDRDm3Da8IOE2vJHQ6j-16qofhkvsuNpfQ",
            authDomain: "ludo-eea76.firebaseapp.com",
            databaseURL: "https://ludo-eea76-default-rtdb.firebaseio.com",
            projectId: "ludo-eea76",
            storageBucket: "ludo-eea76.firebasestorage.app",
            messagingSenderId: "249574298911",
            appId: "1:249574298911:web:3e087f9eb96d67d2d14c2a",
            measurementId: "G-4LRR00CHK3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Game state variables
        let roomId = null;
        let playerId = null;
        let playerName = "Player";
        let playerColor = "red";
        let isHoster = false;
        let currentPlayer = "red";
        let diceValue = 0;
        let players = ["red", "green", "blue", "yellow"];
        let playersEle = [[],[],[],[]];
        let homeSpots = [[],[],[],[]];
        let SCDivs = [];
        let betweenDivs = [];
        let allPathCells = {};
        let selectedToken = null;
        let gameActive = false;
        let myTurn = false;
        
        // DOM elements
        const setupScreen = document.getElementById('setupScreen');
        const gameScreen = document.getElementById('gameScreen');
        const playerNameInput = document.getElementById('playerName');
        const roomActionSelect = document.getElementById('roomAction');
        const roomIdGroup = document.getElementById('roomIdGroup');
        const roomIdInput = document.getElementById('roomId');
        const startGameBtn = document.getElementById('startGame');
        const roomInfo = document.getElementById('roomInfo');
        const shareRoomId = document.getElementById('shareRoomId');
        const gameStatus = document.getElementById('gameStatus');
        const colorOptions = document.querySelectorAll('.color-option');

        // Event listeners for setup
        roomActionSelect.addEventListener('change', function() {
            roomIdGroup.style.display = this.value === 'join' ? 'block' : 'none';
        });

        colorOptions.forEach(option => {
            option.addEventListener('click', function() {
                colorOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                playerColor = this.getAttribute('data-color');
            });
        });

        startGameBtn.addEventListener('click', startGame);

        // Generate a unique player ID
        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        // Generate a room ID
        function generateRoomId() {
            return 'room_' + Math.random().toString(36).substr(2, 9);
        }

        // Start the game setup
        function startGame() {
            playerName = playerNameInput.value || "Player";
            playerId = generatePlayerId();
            
            if (roomActionSelect.value === 'create') {
                roomId = generateRoomId();
                isHoster = true;
                shareRoomId.textContent = roomId;
                roomInfo.classList.remove('hidden');
                initializeGameRoom();
            } else {
                roomId = roomIdInput.value.trim();
                if (!roomId) {
                    alert('Please enter a room ID');
                    return;
                }
                isHoster = false;
                joinGameRoom();
            }
            
            // Store in localStorage for page refresh
            localStorage.setItem('playerId', playerId);
            localStorage.setItem('playerName', playerName);
            localStorage.setItem('playerColor', playerColor);
            localStorage.setItem('roomId', roomId);
            localStorage.setItem('isHoster', isHoster);
            
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            initializeGameBoard();
        }

        // Initialize a new game room
        function initializeGameRoom() {
            const gameRef = ref(db, `ludo-rooms/${roomId}`);
            
            const initialGameState = {
                host: playerId,
                players: {
                    [playerId]: {
                        name: playerName,
                        color: playerColor,
                        joinedAt: Date.now()
                    }
                },
                gameState: "waiting",
                currentPlayer: "red",
                diceValue: 0,
                boardState: {},
                lastAction: null,
                winner: null,
                createdAt: Date.now()
            };
            
            set(gameRef, initialGameState)
                .then(() => {
                    console.log("Game room created successfully");
                    listenToGameUpdates();
                })
                .catch((error) => {
                    console.error("Error creating game room:", error);
                });
        }

        // Join an existing game room
        function joinGameRoom() {
            const gameRef = ref(db, `ludo-rooms/${roomId}`);
            
            get(gameRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    
                    // Check if room is full (max 4 players)
                    if (Object.keys(gameData.players).length >= 4) {
                        alert('This room is already full');
                        return;
                    }
                    
                    // Check if color is already taken
                    const takenColors = Object.values(gameData.players).map(p => p.color);
                    if (takenColors.includes(playerColor)) {
                        alert('This color is already taken. Please choose another color.');
                        return;
                    }
                    
                    // Add player to the room
                    const updates = {};
                    updates[`players/${playerId}`] = {
                        name: playerName,
                        color: playerColor,
                        joinedAt: Date.now()
                    };
                    
                    update(gameRef, updates)
                        .then(() => {
                            console.log("Joined game room successfully");
                            listenToGameUpdates();
                        })
                        .catch((error) => {
                            console.error("Error joining game room:", error);
                        });
                } else {
                    alert('Room not found. Please check the room ID.');
                }
            }).catch((error) => {
                console.error("Error checking room:", error);
                alert('Error connecting to the game room. Please try again.');
            });
        }

        // Listen for game updates from Firebase
        function listenToGameUpdates() {
            const gameRef = ref(db, `ludo-rooms/${roomId}`);
            
            onValue(gameRef, (snapshot) => {
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    processGameUpdate(gameData);
                } else {
                    console.log("Room doesn't exist");
                }
            });
        }

        // Process game updates from Firebase
        function processGameUpdate(gameData) {
            // Update game status
            updateGameStatus(gameData);
            
            // Update current player
            if (gameData.currentPlayer && gameData.currentPlayer !== currentPlayer) {
                currentPlayer = gameData.currentPlayer;
                myTurn = currentPlayer === playerColor;
                updatePlayerTurn();
            }
            
            // Update dice value
            if (gameData.diceValue !== diceValue) {
                diceValue = gameData.diceValue;
                updateDiceDisplay();
            }
            
            // Update board state if available
            if (gameData.boardState && Object.keys(gameData.boardState).length > 0) {
                applyBoardState(gameData.boardState);
            }
            
            // Handle last action
            if (gameData.lastAction && gameData.lastAction.playerId !== playerId) {
                handleRemoteAction(gameData.lastAction);
            }
            
            // Check for winner
            if (gameData.winner && !gameData.winnerProcessed) {
                handleGameWinner(gameData.winner);
                // Mark winner as processed
                const gameRef = ref(db, `ludo-rooms/${roomId}`);
                update(gameRef, { winnerProcessed: true });
            }
        }

        // Update game status display
        function updateGameStatus(gameData) {
            let statusText = "";
            
            if (gameData.gameState === "waiting") {
                const playerCount = Object.keys(gameData.players || {}).length;
                statusText = `Waiting for players... (${playerCount}/4)`;
            } else if (gameData.gameState === "playing") {
                statusText = `Current turn: ${gameData.currentPlayer}`;
                if (myTurn) {
                    statusText += " - YOUR TURN!";
                }
            } else if (gameData.gameState === "finished") {
                statusText = `Game over! Winner: ${gameData.winner}`;
            }
            
            gameStatus.textContent = statusText;
        }

        // Update player turn display
        function updatePlayerTurn() {
            const rollers = document.querySelectorAll('.roller');
            rollers.forEach(roller => {
                const color = roller.getAttribute('data-color');
                
                if (color === currentPlayer && color === playerColor) {
                    roller.disabled = false;
                    roller.style.opacity = "1";
                } else {
                    roller.disabled = true;
                    roller.style.opacity = "0.6";
                }
            });
            
            // If it's my turn and I haven't rolled yet, enable roll
            if (myTurn && diceValue === 0) {
                enableRoll();
            } else if (myTurn && diceValue > 0) {
                // If I've rolled, enable token selection
                enableTokenSelection();
            }
        }

        // Update dice display
        function updateDiceDisplay() {
            const dice = document.querySelector(`.roller[data-color="${currentPlayer}"] .dice`);
            if (dice) {
                dice.setAttribute('data-value', diceValue);
            }
        }

        // Enable roll for current player
        function enableRoll() {
            const myRoller = document.querySelector(`.roller[data-color="${playerColor}"]`);
            if (myRoller && myTurn) {
                myRoller.addEventListener('click', rollDiceHandler, { once: true });
            }
        }

        // Roll dice handler
        function rollDiceHandler() {
            if (!myTurn) return;
            
            const dice = this.querySelector('.dice');
            rollDiceAnimation(dice, () => {
                // After animation, send roll to Firebase
                sendDiceRoll();
            });
        }

        // Animate dice roll
        function rollDiceAnimation(diceElement, callback) {
            let rolls = 0;
            const maxRolls = 10;
            const rollInterval = setInterval(() => {
                const randomValue = Math.floor(Math.random() * 6) + 1;
                diceElement.setAttribute('data-value', randomValue);
                rolls++;
                if (rolls >= maxRolls) {
                    clearInterval(rollInterval);
                    diceValue = randomValue;
                    diceElement.setAttribute('data-value', diceValue);
                    if (callback) callback();
                }
            }, 100);
        }

        // Send dice roll to Firebase
        function sendDiceRoll() {
            const gameRef = ref(db, `ludo-rooms/${roomId}`);
            const updates = {
                diceValue: diceValue,
                lastAction: {
                    type: "roll",
                    playerId: playerId,
                    playerColor: playerColor,
                    diceValue: diceValue,
                    timestamp: Date.now()
                }
            };
            
            update(gameRef, updates)
                .then(() => {
                    console.log("Dice roll sent to Firebase");
                    // After rolling, check if auto-move is possible
                    const autoMoveResult = checkAutoMove();
                    if (autoMoveResult === "nextTurn") {
                        nextTurn();
                    } else if (autoMoveResult === "autoMove") {
                        // Automatically move the only available token
                        const tokens = playersEle[players.indexOf(playerColor)];
                        const outTokens = tokens.filter(t => t.dataset.home === "false");
                        if (outTokens.length === 1) {
                            moveToken(outTokens[0]);
                        }
                    } else {
                        // Enable token selection
                        enableTokenSelection();
                    }
                })
                .catch((error) => {
                    console.error("Error sending dice roll:", error);
                });
        }

        // Check if auto-move is possible
        function checkAutoMove() {
            const tokens = playersEle[players.indexOf(playerColor)];
            const homeTokens = tokens.filter(t => t.dataset.home === "true");
            const outTokens = tokens.filter(t => t.dataset.home === "false");
            
            // All tokens in home and no 6
            if (homeTokens.length === tokens.length && diceValue !== 6) {
                return "nextTurn";
            }
            
            // Only one token out and no 6
            if (outTokens.length === 1 && diceValue !== 6) {
                return "autoMove";
            }
            
            return null;
        }

        // Enable token selection after dice roll
        function enableTokenSelection() {
            if (!myTurn) return;
            
            const tokens = playersEle[players.indexOf(playerColor)];
            tokens.forEach(token => {
                // Check if token can be moved
                if (canTokenMove(token)) {
                    token.classList.add('selectable');
                    token.style.cursor = 'pointer';
                    token.addEventListener('click', tokenClickHandler);
                }
            });
        }

        // Check if a token can be moved
        function canTokenMove(token) {
            if (token.dataset.home === "true") {
                return diceValue === 6;
            }
            
            // Check if move is within bounds
            const currentId = parseInt(token.dataset.idno);
            return checkMoveLimit(playerColor, currentId, diceValue);
        }

        // Check move limits
        function checkMoveLimit(color, currentId, steps) {
            // Simplified implementation - you would expand this with your game logic
            return true;
        }

        // Token click handler
        function tokenClickHandler(e) {
            if (!myTurn) return;
            
            const token = e.currentTarget;
            moveToken(token);
        }

        // Move token
        function moveToken(token) {
            disableTokenSelection();
            
            // Send move to Firebase
            sendTokenMove(token);
        }

        // Send token move to Firebase
        function sendTokenMove(token) {
            const tokenIndex = playersEle[players.indexOf(playerColor)].indexOf(token);
            const gameRef = ref(db, `ludo-rooms/${roomId}`);
            
            const updates = {
                lastAction: {
                    type: "move",
                    playerId: playerId,
                    playerColor: playerColor,
                    tokenIndex: tokenIndex,
                    diceValue: diceValue,
                    timestamp: Date.now()
                }
            };
            
            update(gameRef, updates)
                .then(() => {
                    console.log("Token move sent to Firebase");
                    // In a full implementation, you would calculate the new position
                    // and update the board state in Firebase
                })
                .catch((error) => {
                    console.error("Error sending token move:", error);
                });
        }

        // Disable token selection
        function disableTokenSelection() {
            const tokens = playersEle[players.indexOf(playerColor)];
            tokens.forEach(token => {
                token.classList.remove('selectable');
                token.style.cursor = 'default';
                token.removeEventListener('click', tokenClickHandler);
            });
        }

        // Handle remote actions from other players
        function handleRemoteAction(action) {
            switch (action.type) {
                case "roll":
                    // Update UI for remote player's roll
                    diceValue = action.diceValue;
                    updateDiceDisplay();
                    break;
                case "move":
                    // Animate remote player's move
                    animateRemoteMove(action);
                    break;
            }
        }

        // Animate remote player's move
        function animateRemoteMove(action) {
            // Implementation for animating remote player's move
            // This would use similar logic to your existing animateTokenMovement function
            console.log("Animating remote move for", action.playerColor);
        }

        // Apply board state from Firebase
        function applyBoardState(boardState) {
            // Implementation for applying the board state from Firebase
            // This would update token positions based on the saved state
        }

        // Handle game winner
        function handleGameWinner(winner) {
            gameStatus.textContent = `Game over! ${winner.toUpperCase()} wins!`;
            alert(`${winner.toUpperCase()} wins the game!`);
        }

        // Move to next turn
        function nextTurn() {
            const currentIndex = players.indexOf(currentPlayer);
            const nextPlayer = players[(currentIndex + 1) % players.length];
            
            const gameRef = ref(db, `ludo-rooms/${roomId}`);
            const updates = {
                currentPlayer: nextPlayer,
                diceValue: 0,
                lastAction: {
                    type: "turnChange",
                    from: currentPlayer,
                    to: nextPlayer,
                    timestamp: Date.now()
                }
            };
            
            update(gameRef, updates)
                .then(() => {
                    console.log("Turn changed to", nextPlayer);
                })
                .catch((error) => {
                    console.error("Error changing turn:", error);
                });
        }

        // Initialize the game board
        function initializeGameBoard() {
            // Your existing board initialization code would go here
            betweenDivs = document.querySelectorAll(".btwn");
            SCDivs = document.querySelectorAll(".sub-container");
            
            // Create cells in between divs
            betweenDivs.forEach(div => {
                for (let k = 0; k < 18; k++) {
                    let cell = document.createElement("div");
                    div.appendChild(cell);
                    cell.classList.add("cell");
                }
            });
            
            // Set up pathways (simplified)
            setupPathways();
            
            // Organize player tokens
            organizePlayerTokens();
            
            // Set up dice rollers
            setupDiceRollers();
            
            // Update initial game status
            gameStatus.textContent = "Game starting...";
        }

        // Set up pathways (simplified)
        function setupPathways() {
            // This would contain your existing pathway setup logic
        }

        // Organize player tokens
        function organizePlayerTokens() {
            const SCDA = [["left","top"],["right","top"],["left","bottom"],["right","bottom"]];
            const colorOrder = ["red","green","blue","yellow"];
            
            for(let i = 0; i < SCDivs.length; i++){
                homeSpots[i] = [];
                for(let k = 0; k < 4; k++){        
                    let div = document.createElement("div");
                    SCDivs[i].appendChild(div);
                    div.style.cssText = `
                        position: absolute;
                        ${SCDA[k][0]}: 10px;
                        ${SCDA[k][1]}: 10px;     
                        width: 30px; 
                        height: 30px;
                        border-radius: 50%;       
                        background: ${colorOrder[i]};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    homeSpots[i][k] = div;

                    let PlayerDiv = document.createElement("div");
                    div.appendChild(PlayerDiv);
                    PlayerDiv.classList.add(`${colorOrder[i]}-player`);
                    PlayerDiv.classList.add("player");
                    PlayerDiv.dataset.home = "true";
                    PlayerDiv.dataset.index = k;
                    playersEle[i][k] = PlayerDiv;
                }
            }
        }

        // Set up dice rollers
        function setupDiceRollers() {
            const rollers = document.querySelectorAll('.roller');
            rollers.forEach(roller => {
                const color = roller.getAttribute('data-color');
                if (color === playerColor) {
                    // This is my roller - will be enabled on my turn
                    roller.disabled = true;
                } else {
                    // Other players' rollers - always disabled
                    roller.disabled = true;
                    roller.style.opacity = "0.6";
                }
            });
        }

        // Check if page was refreshed and restore state
        function checkForExistingGame() {
            const savedPlayerId = localStorage.getItem('playerId');
            const savedRoomId = localStorage.getItem('roomId');
            
            if (savedPlayerId && savedRoomId) {
                playerId = savedPlayerId;
                playerName = localStorage.getItem('playerName') || "Player";
                playerColor = localStorage.getItem('playerColor') || "red";
                roomId = savedRoomId;
                isHoster = localStorage.getItem('isHoster') === 'true';
                
                playerNameInput.value = playerName;
                roomIdInput.value = roomId;
                
                // Select the correct color option
                colorOptions.forEach(option => {
                    if (option.getAttribute('data-color') === playerColor) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
                
                // Set room action to join
                roomActionSelect.value = 'join';
                roomIdGroup.style.display = 'block';
                
                console.log("Restored previous game state");
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkForExistingGame();
        });
    </script>
</body>
</html>